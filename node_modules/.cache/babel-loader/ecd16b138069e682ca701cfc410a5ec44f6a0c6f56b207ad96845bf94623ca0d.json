{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Luis Escorcia T-blue\\\\Pictures\\\\chat-app\\\\chat-app\\\\src\\\\components\\\\ChatWindow.js\",\n  _s = $RefreshSig$();\nimport { useState, useEffect, useRef } from 'react';\nimport { supabase } from '../utils/supabaseClient';\nimport { useAuth } from '../context/AuthContext';\nimport { format } from 'date-fns';\nimport { es } from 'date-fns/locale';\nimport './ChatWindow.css';\n\n// Límite máximo de tamaño para archivos adjuntos (5MB).\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst MAX_FILE_SIZE = 5 * 1024 * 1024;\n\n/**\n * AvatarEl: Muestra la foto del contacto o su inicial.\n */\nfunction AvatarEl({\n  profile,\n  size = 32\n}) {\n  if (profile !== null && profile !== void 0 && profile.avatar_url) {\n    return /*#__PURE__*/_jsxDEV(\"img\", {\n      src: profile.avatar_url,\n      alt: \"\",\n      className: \"avatar\",\n      style: {\n        width: size,\n        height: size\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 16,\n      columnNumber: 12\n    }, this);\n  }\n  const initial = ((profile === null || profile === void 0 ? void 0 : profile.display_name) || (profile === null || profile === void 0 ? void 0 : profile.username) || '?')[0].toUpperCase();\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"avatar-placeholder\",\n    style: {\n      width: size,\n      height: size,\n      fontSize: size * 0.38\n    },\n    children: initial\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 20,\n    columnNumber: 5\n  }, this);\n}\n\n/**\n * ChatWindow: Componente principal para la interfaz de conversación activa.\n */\n_c = AvatarEl;\nexport default function ChatWindow({\n  conversation\n}) {\n  _s();\n  const {\n    user\n  } = useAuth();\n  const [messages, setMessages] = useState([]); // Almacena el historial de mensajes\n  const [text, setText] = useState(''); // Texto del input de mensaje\n  const [sending, setSending] = useState(false); // Estado de envío de texto\n  const [uploading, setUploading] = useState(false); // Estado de subida de archivos\n  const bottomRef = useRef(null); // Referencia para scroll automático\n  const fileInputRef = useRef(null); // Referencia al input de archivos oculto\n\n  // Identificar quién es el \"otro\" usuario en la conversación privada.\n  const otherUser = conversation.user1.id === user.id ? conversation.user2 : conversation.user1;\n  useEffect(() => {\n    fetchMessages();\n\n    // --- SUSCRIPCIÓN EN TIEMPO REAL AL CANAL DE ESTA CONVERSACIÓN ---\n    const sub = supabase.channel(`conv-${conversation.id}`).on('postgres_changes', {\n      event: 'INSERT',\n      schema: 'public',\n      table: 'messages',\n      filter: `conversation_id=eq.${conversation.id}`\n    }, async payload => {\n      const newMsg = payload.new;\n\n      // Si el nuevo mensaje es un archivo, generamos una URL firmada para visualizarlo.\n      if (newMsg.message_type === 'file' && newMsg.file_url && !newMsg.file_url.startsWith('http')) {\n        const {\n          data\n        } = await supabase.storage.from('chat-files').createSignedUrl(newMsg.file_url, 3600);\n        setMessages(prev => [...prev, {\n          ...newMsg,\n          signed_url: (data === null || data === void 0 ? void 0 : data.signedUrl) || null\n        }]);\n      } else {\n        setMessages(prev => [...prev, newMsg]);\n      }\n      markAsRead(); // Marcar automáticamente como leído al recibirlo si el chat está abierto\n      scrollToBottom();\n    }).subscribe();\n    return () => supabase.removeChannel(sub);\n  }, [conversation.id]);\n  useEffect(() => {\n    scrollToBottom();\n    markAsRead();\n  }, [messages.length]);\n\n  /**\n   * Genera URLs firmadas temporales (1 hora) para mensajes que contienen archivos privados en Storage.\n   */\n  async function resolveSignedUrls(msgs) {\n    return Promise.all(msgs.map(async msg => {\n      if (msg.message_type !== 'file' || !msg.file_url) return msg;\n      if (msg.file_url.startsWith('http')) return msg;\n      const {\n        data\n      } = await supabase.storage.from('chat-files').createSignedUrl(msg.file_url, 3600);\n      return {\n        ...msg,\n        signed_url: (data === null || data === void 0 ? void 0 : data.signedUrl) || null\n      };\n    }));\n  }\n\n  /**\n   * Carga el historial de mensajes de la base de datos.\n   */\n  async function fetchMessages() {\n    const {\n      data\n    } = await supabase.from('messages').select('*').eq('conversation_id', conversation.id).order('created_at', {\n      ascending: true\n    });\n    const resolved = await resolveSignedUrls(data || []);\n    setMessages(resolved);\n    markAsRead();\n    setTimeout(scrollToBottom, 100);\n  }\n\n  /**\n   * Marca los mensajes recibidos como leídos en la base de datos.\n   */\n  async function markAsRead() {\n    await supabase.from('messages').update({\n      is_read: true\n    }).eq('conversation_id', conversation.id).eq('is_read', false).neq('sender_id', user.id);\n  }\n\n  /**\n   * Desplaza la vista al final del chat de forma suave.\n   */\n  function scrollToBottom() {\n    var _bottomRef$current;\n    (_bottomRef$current = bottomRef.current) === null || _bottomRef$current === void 0 ? void 0 : _bottomRef$current.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }\n\n  /**\n   * Envía un mensaje de texto simple.\n   */\n  async function sendMessage(e) {\n    e.preventDefault();\n    if (!text.trim() || sending) return;\n    setSending(true);\n    const content = text.trim();\n    setText('');\n    await supabase.from('messages').insert({\n      conversation_id: conversation.id,\n      sender_id: user.id,\n      content,\n      message_type: 'text'\n    });\n    setSending(false);\n  }\n\n  /**\n   * Gestiona la subida de archivos al Bucket de Supabase Storage.\n   */\n  async function handleFileUpload(e) {\n    var _e$target$files;\n    const file = (_e$target$files = e.target.files) === null || _e$target$files === void 0 ? void 0 : _e$target$files[0];\n    if (!file) return;\n    if (file.size > MAX_FILE_SIZE) {\n      alert('El archivo no puede superar los 5MB');\n      return;\n    }\n    setUploading(true);\n    const ext = file.name.split('.').pop();\n    const path = `${conversation.id}/${Date.now()}.${ext}`; // Ruta única: folder_conv/timestamp.ext\n\n    // 1. Subir archivo físico al Storage.\n    const {\n      data,\n      error\n    } = await supabase.storage.from('chat-files').upload(path, file);\n    if (error) {\n      alert('Error al subir el archivo: ' + error.message);\n      setUploading(false);\n      return;\n    }\n\n    // 2. Crear el registro del mensaje en la tabla 'messages' apuntando al path del archivo.\n    await supabase.from('messages').insert({\n      conversation_id: conversation.id,\n      sender_id: user.id,\n      content: null,\n      file_url: path,\n      // Guardamos el path relativo en el Bucket\n      file_name: file.name,\n      file_type: file.type,\n      message_type: 'file'\n    });\n    setUploading(false);\n    e.target.value = ''; // Reset del input\n  }\n\n  /**\n   * Verifica si un tipo de archivo es imagen para mostrar vista previa.\n   */\n  function isImage(fileType) {\n    return fileType === null || fileType === void 0 ? void 0 : fileType.startsWith('image/');\n  }\n\n  /**\n   * Agrupa los mensajes por fecha para mostrar divisores de días (\"15 de Enero\").\n   */\n  function groupMessages(msgs) {\n    const groups = [];\n    let currentDate = null;\n    msgs.forEach(msg => {\n      const msgDate = format(new Date(msg.created_at), 'yyyy-MM-dd');\n      if (msgDate !== currentDate) {\n        groups.push({\n          type: 'date',\n          date: msg.created_at\n        });\n        currentDate = msgDate;\n      }\n      groups.push({\n        type: 'message',\n        data: msg\n      });\n    });\n    return groups;\n  }\n  const grouped = groupMessages(messages);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat-window\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-header\",\n      children: [/*#__PURE__*/_jsxDEV(AvatarEl, {\n        profile: otherUser,\n        size: 38\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 218,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-header-info\",\n        children: [/*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"chat-header-name\",\n          children: otherUser.display_name || otherUser.username\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 220,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"chat-header-username\",\n          children: [\"@\", otherUser.username]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 221,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 219,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 217,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"messages-area\",\n      children: [grouped.map((item, idx) => {\n        var _grouped, _grouped2, _grouped2$data, _grouped3;\n        // Renderizar divisor de fecha\n        if (item.type === 'date') {\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"date-divider\",\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              children: format(new Date(item.date), \"d 'de' MMMM, yyyy\", {\n                locale: es\n              })\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 232,\n              columnNumber: 17\n            }, this)\n          }, `date-${idx}`, false, {\n            fileName: _jsxFileName,\n            lineNumber: 231,\n            columnNumber: 15\n          }, this);\n        }\n        const msg = item.data;\n        const isMine = msg.sender_id === user.id;\n        // Lógica para mostrar avatar solo en el último mensaje de un grupo (estética similar a apps modernas)\n        const isLast = idx === grouped.length - 1 || ((_grouped = grouped[idx + 1]) === null || _grouped === void 0 ? void 0 : _grouped.type) === 'message' && ((_grouped2 = grouped[idx + 1]) === null || _grouped2 === void 0 ? void 0 : (_grouped2$data = _grouped2.data) === null || _grouped2$data === void 0 ? void 0 : _grouped2$data.sender_id) !== msg.sender_id || ((_grouped3 = grouped[idx + 1]) === null || _grouped3 === void 0 ? void 0 : _grouped3.type) === 'date';\n        return /*#__PURE__*/_jsxDEV(\"div\", {\n          className: `message-wrapper ${isMine ? 'mine' : 'theirs'}`,\n          children: [!isMine && isLast && /*#__PURE__*/_jsxDEV(AvatarEl, {\n            profile: otherUser,\n            size: 26\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 247,\n            columnNumber: 17\n          }, this), !isMine && !isLast && /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              width: 26\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 249,\n            columnNumber: 38\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `message-bubble ${isMine ? 'mine' : 'theirs'}`,\n            children: [msg.message_type === 'file' ? /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"file-message\",\n              children: !msg.signed_url ? /*#__PURE__*/_jsxDEV(\"span\", {\n                style: {\n                  fontSize: 12,\n                  color: 'var(--text-muted)'\n                },\n                children: \"\\u23F3 Cargando archivo...\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 256,\n                columnNumber: 23\n              }, this) : isImage(msg.file_type) ? /*#__PURE__*/_jsxDEV(\"a\", {\n                href: msg.signed_url,\n                target: \"_blank\",\n                rel: \"noreferrer\",\n                children: /*#__PURE__*/_jsxDEV(\"img\", {\n                  src: msg.signed_url,\n                  alt: msg.file_name,\n                  className: \"image-preview\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 259,\n                  columnNumber: 25\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 258,\n                columnNumber: 23\n              }, this) : /*#__PURE__*/_jsxDEV(\"a\", {\n                href: msg.signed_url,\n                target: \"_blank\",\n                rel: \"noreferrer\",\n                className: \"file-link\",\n                children: [/*#__PURE__*/_jsxDEV(\"svg\", {\n                  width: \"18\",\n                  height: \"18\",\n                  viewBox: \"0 0 24 24\",\n                  fill: \"none\",\n                  stroke: \"currentColor\",\n                  strokeWidth: \"2\",\n                  children: /*#__PURE__*/_jsxDEV(\"path\", {\n                    d: \"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 264,\n                    columnNumber: 27\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 263,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: msg.file_name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 266,\n                  columnNumber: 25\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 262,\n                columnNumber: 23\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 253,\n              columnNumber: 19\n            }, this) : /*#__PURE__*/_jsxDEV(\"p\", {\n              className: \"message-text\",\n              children: msg.content\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 271,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"message-meta\",\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"message-time\",\n                children: format(new Date(msg.created_at), 'HH:mm')\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 276,\n                columnNumber: 19\n              }, this), isMine && /*#__PURE__*/_jsxDEV(\"span\", {\n                className: `read-status ${msg.is_read ? 'read' : ''}`,\n                children: msg.is_read ? '✓✓' : '✓'\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 280,\n                columnNumber: 21\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 275,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 251,\n            columnNumber: 15\n          }, this)]\n        }, msg.id, true, {\n          fileName: _jsxFileName,\n          lineNumber: 245,\n          columnNumber: 13\n        }, this);\n      }), /*#__PURE__*/_jsxDEV(\"div\", {\n        ref: bottomRef\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 290,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 226,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n      className: \"chat-input-area\",\n      onSubmit: sendMessage,\n      children: [/*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"file\",\n        ref: fileInputRef,\n        onChange: handleFileUpload,\n        style: {\n          display: 'none'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 295,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        type: \"button\",\n        className: \"attach-btn\",\n        onClick: () => {\n          var _fileInputRef$current;\n          return (_fileInputRef$current = fileInputRef.current) === null || _fileInputRef$current === void 0 ? void 0 : _fileInputRef$current.click();\n        },\n        disabled: uploading,\n        title: \"Adjuntar archivo\",\n        children: uploading ? /*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"spinner\",\n          style: {\n            width: 18,\n            height: 18,\n            borderWidth: 2\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 309,\n          columnNumber: 13\n        }, this) : /*#__PURE__*/_jsxDEV(\"svg\", {\n          width: \"20\",\n          height: \"20\",\n          viewBox: \"0 0 24 24\",\n          fill: \"none\",\n          stroke: \"currentColor\",\n          strokeWidth: \"2\",\n          children: /*#__PURE__*/_jsxDEV(\"path\", {\n            d: \"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 312,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 311,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 301,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n        className: \"message-input\",\n        placeholder: \"Escribe un mensaje...\",\n        value: text,\n        onChange: e => setText(e.target.value),\n        onKeyDown: e => {\n          if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            sendMessage(e);\n          }\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 317,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        type: \"submit\",\n        className: \"send-btn\",\n        disabled: !text.trim() || sending,\n        children: /*#__PURE__*/_jsxDEV(\"svg\", {\n          width: \"20\",\n          height: \"20\",\n          viewBox: \"0 0 24 24\",\n          fill: \"none\",\n          stroke: \"currentColor\",\n          strokeWidth: \"2\",\n          children: [/*#__PURE__*/_jsxDEV(\"line\", {\n            x1: \"22\",\n            y1: \"2\",\n            x2: \"11\",\n            y2: \"13\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 327,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"polygon\", {\n            points: \"22 2 15 22 11 13 2 9 22 2\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 328,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 326,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 325,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 294,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 215,\n    columnNumber: 5\n  }, this);\n}\n_s(ChatWindow, \"CuGaCHhyeY0NBAYVCZP/Ivlj8og=\", false, function () {\n  return [useAuth];\n});\n_c2 = ChatWindow;\nvar _c, _c2;\n$RefreshReg$(_c, \"AvatarEl\");\n$RefreshReg$(_c2, \"ChatWindow\");","map":{"version":3,"names":["useState","useEffect","useRef","supabase","useAuth","format","es","jsxDEV","_jsxDEV","MAX_FILE_SIZE","AvatarEl","profile","size","avatar_url","src","alt","className","style","width","height","fileName","_jsxFileName","lineNumber","columnNumber","initial","display_name","username","toUpperCase","fontSize","children","_c","ChatWindow","conversation","_s","user","messages","setMessages","text","setText","sending","setSending","uploading","setUploading","bottomRef","fileInputRef","otherUser","user1","id","user2","fetchMessages","sub","channel","on","event","schema","table","filter","payload","newMsg","new","message_type","file_url","startsWith","data","storage","from","createSignedUrl","prev","signed_url","signedUrl","markAsRead","scrollToBottom","subscribe","removeChannel","length","resolveSignedUrls","msgs","Promise","all","map","msg","select","eq","order","ascending","resolved","setTimeout","update","is_read","neq","_bottomRef$current","current","scrollIntoView","behavior","sendMessage","e","preventDefault","trim","content","insert","conversation_id","sender_id","handleFileUpload","_e$target$files","file","target","files","alert","ext","name","split","pop","path","Date","now","error","upload","message","file_name","file_type","type","value","isImage","fileType","groupMessages","groups","currentDate","forEach","msgDate","created_at","push","date","grouped","item","idx","_grouped","_grouped2","_grouped2$data","_grouped3","locale","isMine","isLast","color","href","rel","viewBox","fill","stroke","strokeWidth","d","ref","onSubmit","onChange","display","onClick","_fileInputRef$current","click","disabled","title","borderWidth","placeholder","onKeyDown","key","shiftKey","x1","y1","x2","y2","points","_c2","$RefreshReg$"],"sources":["C:/Users/Luis Escorcia T-blue/Pictures/chat-app/chat-app/src/components/ChatWindow.js"],"sourcesContent":["import { useState, useEffect, useRef } from 'react'\nimport { supabase } from '../utils/supabaseClient'\nimport { useAuth } from '../context/AuthContext'\nimport { format } from 'date-fns'\nimport { es } from 'date-fns/locale'\nimport './ChatWindow.css'\n\n// Límite máximo de tamaño para archivos adjuntos (5MB).\nconst MAX_FILE_SIZE = 5 * 1024 * 1024\n\n/**\n * AvatarEl: Muestra la foto del contacto o su inicial.\n */\nfunction AvatarEl({ profile, size = 32 }) {\n  if (profile?.avatar_url) {\n    return <img src={profile.avatar_url} alt=\"\" className=\"avatar\" style={{ width: size, height: size }} />\n  }\n  const initial = (profile?.display_name || profile?.username || '?')[0].toUpperCase()\n  return (\n    <div className=\"avatar-placeholder\" style={{ width: size, height: size, fontSize: size * 0.38 }}>\n      {initial}\n    </div>\n  )\n}\n\n/**\n * ChatWindow: Componente principal para la interfaz de conversación activa.\n */\nexport default function ChatWindow({ conversation }) {\n  const { user } = useAuth()\n  const [messages, setMessages] = useState([]) // Almacena el historial de mensajes\n  const [text, setText] = useState('')         // Texto del input de mensaje\n  const [sending, setSending] = useState(false) // Estado de envío de texto\n  const [uploading, setUploading] = useState(false) // Estado de subida de archivos\n  const bottomRef = useRef(null)               // Referencia para scroll automático\n  const fileInputRef = useRef(null)            // Referencia al input de archivos oculto\n\n  // Identificar quién es el \"otro\" usuario en la conversación privada.\n  const otherUser = conversation.user1.id === user.id ? conversation.user2 : conversation.user1\n\n  useEffect(() => {\n    fetchMessages()\n\n    // --- SUSCRIPCIÓN EN TIEMPO REAL AL CANAL DE ESTA CONVERSACIÓN ---\n    const sub = supabase\n      .channel(`conv-${conversation.id}`)\n      .on('postgres_changes', {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'messages',\n        filter: `conversation_id=eq.${conversation.id}`\n      }, async (payload) => {\n        const newMsg = payload.new\n\n        // Si el nuevo mensaje es un archivo, generamos una URL firmada para visualizarlo.\n        if (newMsg.message_type === 'file' && newMsg.file_url && !newMsg.file_url.startsWith('http')) {\n          const { data } = await supabase.storage\n            .from('chat-files')\n            .createSignedUrl(newMsg.file_url, 3600)\n          setMessages(prev => [...prev, { ...newMsg, signed_url: data?.signedUrl || null }])\n        } else {\n          setMessages(prev => [...prev, newMsg])\n        }\n\n        markAsRead()    // Marcar automáticamente como leído al recibirlo si el chat está abierto\n        scrollToBottom()\n      })\n      .subscribe()\n\n    return () => supabase.removeChannel(sub)\n  }, [conversation.id])\n\n  useEffect(() => {\n    scrollToBottom()\n    markAsRead()\n  }, [messages.length])\n\n  /**\n   * Genera URLs firmadas temporales (1 hora) para mensajes que contienen archivos privados en Storage.\n   */\n  async function resolveSignedUrls(msgs) {\n    return Promise.all(msgs.map(async (msg) => {\n      if (msg.message_type !== 'file' || !msg.file_url) return msg\n      if (msg.file_url.startsWith('http')) return msg\n      const { data } = await supabase.storage\n        .from('chat-files')\n        .createSignedUrl(msg.file_url, 3600)\n      return { ...msg, signed_url: data?.signedUrl || null }\n    }))\n  }\n\n  /**\n   * Carga el historial de mensajes de la base de datos.\n   */\n  async function fetchMessages() {\n    const { data } = await supabase\n      .from('messages')\n      .select('*')\n      .eq('conversation_id', conversation.id)\n      .order('created_at', { ascending: true })\n    const resolved = await resolveSignedUrls(data || [])\n    setMessages(resolved)\n    markAsRead()\n    setTimeout(scrollToBottom, 100)\n  }\n\n  /**\n   * Marca los mensajes recibidos como leídos en la base de datos.\n   */\n  async function markAsRead() {\n    await supabase\n      .from('messages')\n      .update({ is_read: true })\n      .eq('conversation_id', conversation.id)\n      .eq('is_read', false)\n      .neq('sender_id', user.id)\n  }\n\n  /**\n   * Desplaza la vista al final del chat de forma suave.\n   */\n  function scrollToBottom() {\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' })\n  }\n\n  /**\n   * Envía un mensaje de texto simple.\n   */\n  async function sendMessage(e) {\n    e.preventDefault()\n    if (!text.trim() || sending) return\n    setSending(true)\n    const content = text.trim()\n    setText('')\n\n    await supabase.from('messages').insert({\n      conversation_id: conversation.id,\n      sender_id: user.id,\n      content,\n      message_type: 'text'\n    })\n    setSending(false)\n  }\n\n  /**\n   * Gestiona la subida de archivos al Bucket de Supabase Storage.\n   */\n  async function handleFileUpload(e) {\n    const file = e.target.files?.[0]\n    if (!file) return\n\n    if (file.size > MAX_FILE_SIZE) {\n      alert('El archivo no puede superar los 5MB')\n      return\n    }\n\n    setUploading(true)\n    const ext = file.name.split('.').pop()\n    const path = `${conversation.id}/${Date.now()}.${ext}` // Ruta única: folder_conv/timestamp.ext\n\n    // 1. Subir archivo físico al Storage.\n    const { data, error } = await supabase.storage\n      .from('chat-files')\n      .upload(path, file)\n\n    if (error) {\n      alert('Error al subir el archivo: ' + error.message)\n      setUploading(false)\n      return\n    }\n\n    // 2. Crear el registro del mensaje en la tabla 'messages' apuntando al path del archivo.\n    await supabase.from('messages').insert({\n      conversation_id: conversation.id,\n      sender_id: user.id,\n      content: null,\n      file_url: path,           // Guardamos el path relativo en el Bucket\n      file_name: file.name,\n      file_type: file.type,\n      message_type: 'file'\n    })\n\n    setUploading(false)\n    e.target.value = '' // Reset del input\n  }\n\n  /**\n   * Verifica si un tipo de archivo es imagen para mostrar vista previa.\n   */\n  function isImage(fileType) {\n    return fileType?.startsWith('image/')\n  }\n\n  /**\n   * Agrupa los mensajes por fecha para mostrar divisores de días (\"15 de Enero\").\n   */\n  function groupMessages(msgs) {\n    const groups = []\n    let currentDate = null\n\n    msgs.forEach(msg => {\n      const msgDate = format(new Date(msg.created_at), 'yyyy-MM-dd')\n      if (msgDate !== currentDate) {\n        groups.push({ type: 'date', date: msg.created_at })\n        currentDate = msgDate\n      }\n      groups.push({ type: 'message', data: msg })\n    })\n    return groups\n  }\n\n  const grouped = groupMessages(messages)\n\n  return (\n    <div className=\"chat-window\">\n      {/* Cabecera del chat con info del contacto */}\n      <div className=\"chat-header\">\n        <AvatarEl profile={otherUser} size={38} />\n        <div className=\"chat-header-info\">\n          <span className=\"chat-header-name\">{otherUser.display_name || otherUser.username}</span>\n          <span className=\"chat-header-username\">@{otherUser.username}</span>\n        </div>\n      </div>\n\n      {/* ÁREA DE MENSAJES GRUPADOS */}\n      <div className=\"messages-area\">\n        {grouped.map((item, idx) => {\n          // Renderizar divisor de fecha\n          if (item.type === 'date') {\n            return (\n              <div key={`date-${idx}`} className=\"date-divider\">\n                <span>{format(new Date(item.date), \"d 'de' MMMM, yyyy\", { locale: es })}</span>\n              </div>\n            )\n          }\n\n          const msg = item.data\n          const isMine = msg.sender_id === user.id\n          // Lógica para mostrar avatar solo en el último mensaje de un grupo (estética similar a apps modernas)\n          const isLast = idx === grouped.length - 1 ||\n            (grouped[idx + 1]?.type === 'message' && grouped[idx + 1]?.data?.sender_id !== msg.sender_id) ||\n            grouped[idx + 1]?.type === 'date'\n\n          return (\n            <div key={msg.id} className={`message-wrapper ${isMine ? 'mine' : 'theirs'}`}>\n              {!isMine && isLast && (\n                <AvatarEl profile={otherUser} size={26} />\n              )}\n              {!isMine && !isLast && <div style={{ width: 26 }} />}\n\n              <div className={`message-bubble ${isMine ? 'mine' : 'theirs'}`}>\n                {msg.message_type === 'file' ? (\n                  <div className=\"file-message\">\n                    {/* Renderizado de adjuntos (imágenes o archivos genéricos) */}\n                    {!msg.signed_url ? (\n                      <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>⏳ Cargando archivo...</span>\n                    ) : isImage(msg.file_type) ? (\n                      <a href={msg.signed_url} target=\"_blank\" rel=\"noreferrer\">\n                        <img src={msg.signed_url} alt={msg.file_name} className=\"image-preview\" />\n                      </a>\n                    ) : (\n                      <a href={msg.signed_url} target=\"_blank\" rel=\"noreferrer\" className=\"file-link\">\n                        <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n                          <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3\" />\n                        </svg>\n                        <span>{msg.file_name}</span>\n                      </a>\n                    )}\n                  </div>\n                ) : (\n                  <p className=\"message-text\">{msg.content}</p>\n                )}\n\n                {/* Metadatos: hora y tick de lectura */}\n                <div className=\"message-meta\">\n                  <span className=\"message-time\">\n                    {format(new Date(msg.created_at), 'HH:mm')}\n                  </span>\n                  {isMine && (\n                    <span className={`read-status ${msg.is_read ? 'read' : ''}`}>\n                      {msg.is_read ? '✓✓' : '✓'}\n                    </span>\n                  )}\n                </div>\n              </div>\n            </div>\n          )\n        })}\n        {/* Div para scroll automático */}\n        <div ref={bottomRef} />\n      </div>\n\n      {/* ÁREA DE INPUT: Texto y Archivos */}\n      <form className=\"chat-input-area\" onSubmit={sendMessage}>\n        <input\n          type=\"file\"\n          ref={fileInputRef}\n          onChange={handleFileUpload}\n          style={{ display: 'none' }}\n        />\n        <button\n          type=\"button\"\n          className=\"attach-btn\"\n          onClick={() => fileInputRef.current?.click()}\n          disabled={uploading}\n          title=\"Adjuntar archivo\"\n        >\n          {uploading ? (\n            <span className=\"spinner\" style={{ width: 18, height: 18, borderWidth: 2 }} />\n          ) : (\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n              <path d=\"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48\" />\n            </svg>\n          )}\n        </button>\n\n        <input\n          className=\"message-input\"\n          placeholder=\"Escribe un mensaje...\"\n          value={text}\n          onChange={e => setText(e.target.value)}\n          onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(e) } }}\n        />\n\n        <button type=\"submit\" className=\"send-btn\" disabled={!text.trim() || sending}>\n          <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n            <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\" />\n            <polygon points=\"22 2 15 22 11 13 2 9 22 2\" />\n          </svg>\n        </button>\n      </form>\n    </div>\n  )\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}